version: '3.8'

services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      # Mount source code for hot-reload
      - ./src:/app/src:cached
      - ./tests:/app/tests:cached
      - ./pyproject.toml:/app/pyproject.toml:ro
      # Persistent storage for learned state
      - dev-weights:/app/weights
      - dev-checkpoints:/app/checkpoints
      # Cache uv downloads
      - uv-cache:/root/.cache/uv
    environment:
      - MEMORY_DIM=256
      - TTT_VARIANT=mlp
      - LEARNING_RATE=0.01
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    ports:
      - "8765:8765"
    stdin_open: true
    tty: true
    command: /bin/bash

  # Test runner service
  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./src:/app/src:cached
      - ./tests:/app/tests:cached
      - ./pyproject.toml:/app/pyproject.toml:ro
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    command: pytest -v --tb=short

  # Demo runner
  demo:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./src:/app/src:cached
      - ./demo:/app/demo:cached
      - demo-weights:/app/weights
    environment:
      - MEMORY_DIM=256
      - TTT_VARIANT=mlp
      - LEARNING_RATE=0.01
    command: python demo/killer_demo.py

volumes:
  dev-weights:
  dev-checkpoints:
  demo-weights:
  uv-cache:
